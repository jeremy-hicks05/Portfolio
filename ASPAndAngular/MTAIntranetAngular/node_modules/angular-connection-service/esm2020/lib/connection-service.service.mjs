import { EventEmitter, Inject, Injectable, InjectionToken, Optional } from '@angular/core';
import { fromEvent, timer } from 'rxjs';
import { debounceTime, delay, retryWhen, startWith, switchMap, tap } from 'rxjs/operators';
import * as _ from 'lodash';
import { HttpClient } from '@angular/common/http';
import * as i0 from "@angular/core";
import * as i1 from "@angular/common/http";
/**
 * InjectionToken for specifing ConnectionService options.
 */
export const ConnectionServiceOptionsToken = new InjectionToken('ConnectionServiceOptionsToken');
export class ConnectionService {
    constructor(http, options) {
        this.http = http;
        this.stateChangeEventEmitter = new EventEmitter();
        this.currentState = {
            hasInternetAccess: false,
            hasNetworkConnection: window.navigator.onLine
        };
        this.serviceOptions = _.defaults({}, options, ConnectionService.DEFAULT_OPTIONS);
        this.checkNetworkState();
        this.checkInternetState();
    }
    /**
     * Current ConnectionService options. Notice that changing values of the returned object has not effect on service execution.
     * You should use "updateOptions" function.
     */
    get options() {
        return _.clone(this.serviceOptions);
    }
    checkInternetState() {
        if (!_.isNil(this.httpSubscription)) {
            this.httpSubscription.unsubscribe();
        }
        if (this.serviceOptions.enableHeartbeat) {
            this.httpSubscription = timer(0, this.serviceOptions.heartbeatInterval)
                .pipe(switchMap(() => this.http[this.serviceOptions.requestMethod](this.serviceOptions.heartbeatUrl, { responseType: 'text' })), retryWhen(errors => errors.pipe(
            // log error message
            tap(val => {
                console.error('Http error:', val);
                this.currentState.hasInternetAccess = false;
                this.emitEvent();
            }), 
            // restart after 5 seconds
            delay(this.serviceOptions.heartbeatRetryInterval))))
                .subscribe(result => {
                this.currentState.hasInternetAccess = true;
                this.emitEvent();
            });
        }
        else {
            this.currentState.hasInternetAccess = false;
            this.emitEvent();
        }
    }
    checkNetworkState() {
        this.onlineSubscription = fromEvent(window, 'online').subscribe(() => {
            this.currentState.hasNetworkConnection = true;
            this.checkInternetState();
            this.emitEvent();
        });
        this.offlineSubscription = fromEvent(window, 'offline').subscribe(() => {
            this.currentState.hasNetworkConnection = false;
            this.checkInternetState();
            this.emitEvent();
        });
    }
    emitEvent() {
        this.stateChangeEventEmitter.emit(this.currentState);
    }
    ngOnDestroy() {
        try {
            this.offlineSubscription.unsubscribe();
            this.onlineSubscription.unsubscribe();
            this.httpSubscription.unsubscribe();
        }
        catch (e) {
        }
    }
    /**
     * Monitor Network & Internet connection status by subscribing to this observer. If you set "reportCurrentState" to "false" then
     * function will not report current status of the connections when initially subscribed.
     * @param reportCurrentState Report current state when initial subscription. Default is "true"
     */
    monitor(reportCurrentState = true) {
        return reportCurrentState ?
            this.stateChangeEventEmitter.pipe(debounceTime(300), startWith(this.currentState))
            :
                this.stateChangeEventEmitter.pipe(debounceTime(300));
    }
    /**
     * Update options of the service. You could specify partial options object. Values that are not specified will use default / previous
     * option values.
     * @param options Partial option values.
     */
    updateOptions(options) {
        this.serviceOptions = _.defaults({}, options, this.serviceOptions);
        this.checkInternetState();
    }
}
ConnectionService.DEFAULT_OPTIONS = {
    enableHeartbeat: true,
    heartbeatUrl: '//httpstat.us/200',
    heartbeatInterval: 30000,
    heartbeatRetryInterval: 1000,
    requestMethod: 'head'
};
/** @nocollapse */ /** @nocollapse */ ConnectionService.ɵfac = i0.ɵɵngDeclareFactory({ minVersion: "12.0.0", version: "13.0.1", ngImport: i0, type: ConnectionService, deps: [{ token: i1.HttpClient }, { token: ConnectionServiceOptionsToken, optional: true }], target: i0.ɵɵFactoryTarget.Injectable });
/** @nocollapse */ /** @nocollapse */ ConnectionService.ɵprov = i0.ɵɵngDeclareInjectable({ minVersion: "12.0.0", version: "13.0.1", ngImport: i0, type: ConnectionService, providedIn: 'root' });
i0.ɵɵngDeclareClassMetadata({ minVersion: "12.0.0", version: "13.0.1", ngImport: i0, type: ConnectionService, decorators: [{
            type: Injectable,
            args: [{
                    providedIn: 'root'
                }]
        }], ctorParameters: function () { return [{ type: i1.HttpClient }, { type: undefined, decorators: [{
                    type: Inject,
                    args: [ConnectionServiceOptionsToken]
                }, {
                    type: Optional
                }] }]; } });
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiY29ubmVjdGlvbi1zZXJ2aWNlLnNlcnZpY2UuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wcm9qZWN0cy9jb25uZWN0aW9uLXNlcnZpY2Uvc3JjL2xpYi9jb25uZWN0aW9uLXNlcnZpY2Uuc2VydmljZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFBQSxPQUFPLEVBQUMsWUFBWSxFQUFFLE1BQU0sRUFBRSxVQUFVLEVBQUUsY0FBYyxFQUFhLFFBQVEsRUFBQyxNQUFNLGVBQWUsQ0FBQztBQUNwRyxPQUFPLEVBQUMsU0FBUyxFQUE0QixLQUFLLEVBQUMsTUFBTSxNQUFNLENBQUM7QUFDaEUsT0FBTyxFQUFDLFlBQVksRUFBRSxLQUFLLEVBQUUsU0FBUyxFQUFFLFNBQVMsRUFBRSxTQUFTLEVBQUUsR0FBRyxFQUFDLE1BQU0sZ0JBQWdCLENBQUM7QUFDekYsT0FBTyxLQUFLLENBQUMsTUFBTSxRQUFRLENBQUM7QUFDNUIsT0FBTyxFQUFFLFVBQVUsRUFBRSxNQUFNLHNCQUFzQixDQUFDOzs7QUE0Q2xEOztHQUVHO0FBQ0gsTUFBTSxDQUFDLE1BQU0sNkJBQTZCLEdBQTZDLElBQUksY0FBYyxDQUFDLCtCQUErQixDQUFDLENBQUM7QUFLM0ksTUFBTSxPQUFPLGlCQUFpQjtJQTRCNUIsWUFBb0IsSUFBZ0IsRUFBcUQsT0FBaUM7UUFBdEcsU0FBSSxHQUFKLElBQUksQ0FBWTtRQW5CNUIsNEJBQXVCLEdBQUcsSUFBSSxZQUFZLEVBQW1CLENBQUM7UUFFOUQsaUJBQVksR0FBb0I7WUFDdEMsaUJBQWlCLEVBQUUsS0FBSztZQUN4QixvQkFBb0IsRUFBRSxNQUFNLENBQUMsU0FBUyxDQUFDLE1BQU07U0FDOUMsQ0FBQztRQWVBLElBQUksQ0FBQyxjQUFjLEdBQUcsQ0FBQyxDQUFDLFFBQVEsQ0FBQyxFQUFFLEVBQUUsT0FBTyxFQUFFLGlCQUFpQixDQUFDLGVBQWUsQ0FBQyxDQUFDO1FBRWpGLElBQUksQ0FBQyxpQkFBaUIsRUFB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LE9BQU8sQ0FBQyxFQUFFO1NBQ1g7SUFDSCxDQUFDO0lBRUQ7Ozs7T0FJRztJQUNILE9BQU8sQ0FBQyxrQkFBa0IsR0FBRyxJQUFJO1FBQy9CLE9BQU8sa0JBQWtCLENBQUMsQ0FBQztZQUN6QixJQUFJLENBQUMsdUJBQXVCLENBQUMsSUFBSSxDQUMvQixZQUFZLENBQUMsR0FBRyxDQUFDLEVBQ2pCLFNBQVMsQ0FBQyxJQUFJLENBQUMsWUFBWSxDQUFDLENBQzdCO1lBQ0QsQ0FBQztnQkFDRCxJQUFJLENBQUMsdUJBQXVCLENBQUMsSUFBSSxDQUMvQixZQUFZLENBQUMsR0FBRyxDQUFDLENBQ2xCLENBQUM7SUFDTixDQUFDO0lBRUQ7Ozs7T0FJRztJQUNILGFBQWEsQ0FBQyxPQUEwQztRQUN0RCxJQUFJLENBQUMsY0FBYyxHQUFHLENBQUMsQ0FBQyxRQUFRLENBQUMsRUFBRSxFQUFFLE9BQU8sRUFBRSxJQUFJLENBQUMsY0FBYyxDQUFDLENBQUM7UUFDbkUsSUFBSSxDQUFDLGtCQUFrQixFQUFFLENBQUM7SUFDNUIsQ0FBQzs7QUF2SGMsaUNBQWUsR0FBNkI7SUFDekQsZUFBZSxFQUFFLElBQUk7SUFDckIsWUFBWSxFQUFFLG1CQUFtQjtJQUNqQyxpQkFBaUIsRUFBRSxLQUFLO0lBQ3hCLHNCQUFzQixFQUFFLElBQUk7SUFDNUIsYUFBYSxFQUFFLE1BQU07Q0FDckIsQ0FBQTtvSkFQUyxpQkFBaUIsNENBNEJrQiw2QkFBNkI7d0pBNUJoRSxpQkFBaUIsY0FGaEIsTUFBTTsyRkFFUCxpQkFBaUI7a0JBSDdCLFVBQVU7bUJBQUM7b0JBQ1YsVUFBVSxFQUFFLE1BQU07aUJBQ25COzswQkE2QndDLE1BQU07MkJBQUMsNkJBQTZCOzswQkFBRyxRQUFRIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtFdmVudEVtaXR0ZXIsIEluamVjdCwgSW5qZWN0YWJsZSwgSW5qZWN0aW9uVG9rZW4sIE9uRGVzdHJveSwgT3B0aW9uYWx9IGZyb20gJ0Bhbmd1bGFyL2NvcmUnO1xyXG5pbXBvcnQge2Zyb21FdmVudCwgT2JzZXJ2YWJsZSwgU3Vic2NyaXB0aW9uLCB0aW1lcn0gZnJvbSAncnhqcyc7XHJcbmltcG9ydCB7ZGVib3VuY2VUaW1lLCBkZWxheSwgcmV0cnlXaGVuLCBzdGFydFdpdGgsIHN3aXRjaE1hcCwgdGFwfSBmcm9tICdyeGpzL29wZXJhdG9ycyc7XHJcbmltcG9ydCAqIGFzIF8gZnJvbSAnbG9kYXNoJztcclxuaW1wb3J0IHsgSHR0cENsaWVudCB9IGZyb20gJ0Bhbmd1bGFyL2NvbW1vbi9odHRwJztcclxuXHJcbi8qKlxyXG4gKiBJbnN0YW5jZSBvZiB0aGlzIGludGVyZmFjZSBpcyB1c2VkIHRvIHJlcG9ydCBjdXJyZW50IGNvbm5lY3Rpb24gc3RhdHVzLlxyXG4gKi9cclxuZXhwb3J0IGludGVyZmFjZSBDb25uZWN0aW9uU3RhdGUge1xyXG4gIC8qKlxyXG4gICAqIFwiVHJ1ZVwiIGlmIGJyb3dzZXIgaGFzIG5ldHdvcmsgY29ubmVjdGlvbi4gRGV0ZXJtaW5lZCBieSBXaW5kb3cgb2JqZWN0cyBcIm9ubGluZVwiIC8gXCJvZmZsaW5lXCIgZXZlbnRzLlxyXG4gICAqL1xyXG4gIGhhc05ldHdvcmtDb25uZWN0aW9uOiBib29sZWFuO1xyXG4gIC8qKlxyXG4gICAqIFwiVHJ1ZVwiIGlmIGJyb3dzZXIgaGFzIEludGVybmV0IGFjY2Vzcy4gRGV0ZXJtaW5lZCBieSBoZWFydGJlYXQgc3lzdGVtIHdoaWNoIHBlcmlvZGljYWxseSBtYWtlcyByZXF1ZXN0IHRvIGhlYXJ0YmVhdCBVcmwuXHJcbiAgICovXHJcbiAgaGFzSW50ZXJuZXRBY2Nlc3M6IGJvb2xlYW47XHJcbn1cclxuXHJcbi8qKlxyXG4gKiBJbnN0YW5jZSBvZiB0aGlzIGludGVyZmFjZSBjb3VsZCBiZSB1c2VkIHRvIGNvbmZpZ3VyZSBcIkNvbm5lY3Rpb25TZXJ2aWNlXCIuXHJcbiAqL1xyXG5leHBvcnQgaW50ZXJmYWNlIENvbm5lY3Rpb25TZXJ2aWNlT3B0aW9ucyB7XHJcbiAgLyoqXHJcbiAgICogQ29udHJvbHMgdGhlIEludGVybmV0IGNvbm5lY3Rpdml0eSBoZWFydGJlYXQgc3lzdGVtLiBEZWZhdWx0IHZhbHVlIGlzICd0cnVlJy5cclxuICAgKi9cclxuICBlbmFibGVIZWFydGJlYXQ/OiBib29sZWFuO1xyXG4gIC8qKlxyXG4gICAqIFVybCB1c2VkIGZvciBjaGVja2luZyBJbnRlcm5ldCBjb25uZWN0aXZpdHksIGhlYXJ0YmVhdCBzeXN0ZW0gcGVyaW9kaWNhbGx5IG1ha2VzIFwiSEVBRFwiIHJlcXVlc3RzIHRvIHRoaXMgVVJMIHRvIGRldGVybWluZSBJbnRlcm5ldFxyXG4gICAqIGNvbm5lY3Rpb24gc3RhdHVzLiBEZWZhdWx0IHZhbHVlIGlzIFwiLy9pbnRlcm5ldGhlYWx0aHRlc3Qub3JnXCIuXHJcbiAgICovXHJcbiAgaGVhcnRiZWF0VXJsOiBzdHJpbmc7XHJcbiAgLyoqXHJcbiAgICogSW50ZXJ2YWwgdXNlZCB0byBjaGVjayBJbnRlcm5ldCBjb25uZWN0aXZpdHkgc3BlY2lmaWVkIGluIG1pbGxpc2Vjb25kcy4gRGVmYXVsdCB2YWx1ZSBpcyBcIjMwMDAwXCIuXHJcbiAgICovXHJcbiAgaGVhcnRiZWF0SW50ZXJ2YWw6IG51bWJlcjtcclxuICAvKipcclxuICAgKiBJbnRlcnZhbCB1c2VkIHRvIHJldHJ5IEludGVybmV0IGNvbm5lY3Rpdml0eSBjaGVja3Mgd2hlbiBhbiBlcnJvciBpcyBkZXRlY3RlZCAod2hlbiBubyBJbnRlcm5ldCBjb25uZWN0aW9uKS4gRGVmYXVsdCB2YWx1ZSBpcyBcIjEwMDBcIi5cclxuICAgKi9cclxuICBoZWFydGJlYXRSZXRyeUludGVydmFsOiBudW1iZXI7XHJcbiAgLyoqXHJcbiAgICogSFRUUCBtZXRob2QgdXNlZCBmb3IgcmVxdWVzdGluZyBoZWFydGJlYXQgVXJsLiBEZWZhdWx0IGlzICdoZWFkJy5cclxuICAgKi9cclxuICByZXF1ZXN0TWV0aG9kOiAnZ2V0JyB8ICdwb3N0JyB8ICdoZWFkJyB8ICdvcHRpb25zJztcclxuXHJcbn1cclxuXHJcbi8qKlxyXG4gKiBJbmplY3Rpb25Ub2tlbiBmb3Igc3BlY2lmaW5nIENvbm5lY3Rpb25TZXJ2aWNlIG9wdGlvbnMuXHJcbiAqL1xyXG5leHBvcnQgY29uc3QgQ29ubmVjdGlvblNlcnZpY2VPcHRpb25zVG9rZW46IEluamVjdGlvblRva2VuPENvbm5lY3Rpb25TZXJ2aWNlT3B0aW9ucz4gPSBuZXcgSW5qZWN0aW9uVG9rZW4oJ0Nvbm5lY3Rpb25TZXJ2aWNlT3B0aW9uc1Rva2VuJyk7XHJcblxyXG5ASW5qZWN0YWJsZSh7XHJcbiAgcHJvdmlkZWRJbjogJ3Jvb3QnXHJcbn0pXHJcbmV4cG9ydCBjbGFzcyBDb25uZWN0aW9uU2VydmljZSBpbXBsZW1lbnRzIE9uRGVzdHJveSB7XHJcbiAgcHJpdmF0ZSBzdGF0aWMgREVGQVVMVF9PUFRJT05TOiBDb25uZWN0aW9uU2VydmljZU9wdGlvbnMgPSB7XHJcbiAgICBlbmFibGVIZWFydGJlYXQ6IHRydWUsXHJcbiAgICBoZWFydGJlYXRVcmw6ICcvL2h0dHBzdGF0LnVzLzIwMCcsXHJcbiAgICBoZWFydGJlYXRJbnRlcnZhbDogMzAwMDAsXHJcbiAgICBoZWFydGJlYXRSZXRyeUludGVydmFsOiAxMDAwLFxyXG4gICAgcmVxdWVzdE1ldGhvZDogJ2hlYWQnXHJcbiAgfTtcclxuXHJcbiAgcHJpdmF0ZSBzdGF0ZUNoYW5nZUV2ZW50RW1pdHRlciA9IG5ldyBFdmVudEVtaXR0ZXI8Q29ubmVjdGlvblN0YXRlPigpO1xyXG5cclxuICBwcml2YXRlIGN1cnJlbnRTdGF0ZTogQ29ubmVjdGlvblN0YXRlID0ge1xyXG4gICAgaGFzSW50ZXJuZXRBY2Nlc3M6IGZhbHNlLFxyXG4gICAgaGFzTmV0d29ya0Nvbm5lY3Rpb246IHdpbmRvdy5uYXZpZ2F0b3Iub25MaW5lXHJcbiAgfTtcclxuICBwcml2YXRlIG9mZmxpbmVTdWJzY3JpcHRpb24hOiBTdWJzY3JpcHRpb247XHJcbiAgcHJpdmF0ZSBvbmxpbmVTdWJzY3JpcHRpb24hOiBTdWJzY3JpcHRpb247XHJcbiAgcHJpdmF0ZSBodHRwU3Vic2NyaXB0aW9uITogU3Vic2NyaXB0aW9uO1xyXG4gIHByaXZhdGUgc2VydmljZU9wdGlvbnM6IENvbm5lY3Rpb25TZXJ2aWNlT3B0aW9ucztcclxuXHJcbiAgLyoqXHJcbiAgICogQ3VycmVudCBDb25uZWN0aW9uU2VydmljZSBvcHRpb25zLiBOb3RpY2UgdGhhdCBjaGFuZ2luZyB2YWx1ZXMgb2YgdGhlIHJldHVybmVkIG9iamVjdCBoYXMgbm90IGVmZmVjdCBvbiBzZXJ2aWNlIGV4ZWN1dGlvbi5cclxuICAgKiBZb3Ugc2hvdWxkIHVzZSBcInVwZGF0ZU9wdGlvbnNcIiBmdW5jdGlvbi5cclxuICAgKi9cclxuICBnZXQgb3B0aW9ucygpOiBDb25uZWN0aW9uU2VydmljZU9wdGlvbnMge1xyXG4gICAgcmV0dXJuIF8uY2xvbmUodGhpcy5zZXJ2aWNlT3B0aW9ucyk7XHJcbiAgfVxyXG5cclxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGh0dHA6IEh0dHBDbGllbnQsIEBJbmplY3QoQ29ubmVjdGlvblNlcnZpY2VPcHRpb25zVG9rZW4pIEBPcHRpb25hbCgpIG9wdGlvbnM6IENvbm5lY3Rpb25TZXJ2aWNlT3B0aW9ucykge1xyXG4gICAgdGhpcy5zZXJ2aWNlT3B0aW9ucyA9IF8uZGVmYXVsdHMoe30sIG9wdGlvbnMsIENvbm5lY3Rpb25TZXJ2aWNlLkRFRkFVTFRfT1BUSU9OUyk7XHJcblxyXG4gICAgdGhpcy5jaGVja05ldHdvcmtTdGF0ZSgpO1xyXG4gICAgdGhpcy5jaGVja0ludGVybmV0U3RhdGUoKTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgY2hlY2tJbnRlcm5ldFN0YXRlKCkge1xyXG5cclxuICAgIGlmICghXy5pc05pbCh0aGlzLmh0dHBTdWJzY3JpcHRpb24pKSB7XHJcbiAgICAgIHRoaXMuaHR0cFN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xyXG4gICAgfVxyXG5cclxuICAgIGlmICh0aGlzLnNlcnZpY2VPcHRpb25zLmVuYWJsZUhlYXJ0YmVhdCkge1xyXG4gICAgICB0aGlzLmh0dHBTdWJzY3JpcHRpb24gPSB0aW1lcigwLCB0aGlzLnNlcnZpY2VPcHRpb25zLmhlYXJ0YmVhdEludGVydmFsKVxyXG4gICAgICAgIC5waXBlKFxyXG4gICAgICAgICAgc3dpdGNoTWFwKCgpID0+IHRoaXMuaHR0cFt0aGlzLnNlcnZpY2VPcHRpb25zLnJlcXVlc3RNZXRob2RdKHRoaXMuc2VydmljZU9wdGlvbnMuaGVhcnRiZWF0VXJsLCB7cmVzcG9uc2VUeXBlOiAndGV4dCd9KSksXHJcbiAgICAgICAgICByZXRyeVdoZW4oZXJyb3JzID0+XHJcbiAgICAgICAgICAgIGVycm9ycy5waXBlKFxyXG4gICAgICAgICAgICAgIC8vIGxvZyBlcnJvciBtZXNzYWdlXHJcbiAgICAgICAgICAgICAgdGFwKHZhbCA9PiB7XHJcbiAgICAgICAgICAgICAgICBjb25zb2xlLmVycm9yKCdIdHRwIGVycm9yOicsIHZhbCk7XHJcbiAgICAgICAgICAgICAgICB0aGlzLmN1cnJlbnRTdGF0ZS5oYXNJbnRlcm5ldEFjY2VzcyA9IGZhbHNlO1xyXG4gICAgICAgICAgICAgICAgdGhpcy5lbWl0RXZlbnQoKTtcclxuICAgICAgICAgICAgICB9KSxcclxuICAgICAgICAgICAgICAvLyByZXN0YXJ0IGFmdGVyIDUgc2Vjb25kc1xyXG4gICAgICAgICAgICAgIGRlbGF5KHRoaXMuc2VydmljZU9wdGlvbnMuaGVhcnRiZWF0UmV0cnlJbnRlcnZhbClcclxuICAgICAgICAgICAgKVxyXG4gICAgICAgICAgKVxyXG4gICAgICAgIClcclxuICAgICAgICAuc3Vic2NyaWJlKHJlc3VsdCA9PiB7XHJcbiAgICAgICAgICB0aGlzLmN1cnJlbnRTdGF0ZS5oYXNJbnRlcm5ldEFjY2VzcyA9IHRydWU7XHJcbiAgICAgICAgICB0aGlzLmVtaXRFdmVudCgpO1xyXG4gICAgICAgIH0pO1xyXG4gICAgfSBlbHNlIHtcclxuICAgICAgdGhpcy5jdXJyZW50U3RhdGUuaGFzSW50ZXJuZXRBY2Nlc3MgPSBmYWxzZTtcclxuICAgICAgdGhpcy5lbWl0RXZlbnQoKTtcclxuICAgIH1cclxuICB9XHJcblxyXG4gIHByaXZhdGUgY2hlY2tOZXR3b3JrU3RhdGUoKSB7XHJcbiAgICB0aGlzLm9ubGluZVN1YnNjcmlwdGlvbiA9IGZyb21FdmVudCh3aW5kb3csICdvbmxpbmUnKS5zdWJzY3JpYmUoKCkgPT4ge1xyXG4gICAgICB0aGlzLmN1cnJlbnRTdGF0ZS5oYXNOZXR3b3JrQ29ubmVjdGlvbiA9IHRydWU7XHJcbiAgICAgIHRoaXMuY2hlY2tJbnRlcm5ldFN0YXRlKCk7XHJcbiAgICAgIHRoaXMuZW1pdEV2ZW50KCk7XHJcbiAgICB9KTtcclxuXHJcbiAgICB0aGlzLm9mZmxpbmVTdWJzY3JpcHRpb24gPSBmcm9tRXZlbnQod2luZG93LCAnb2ZmbGluZScpLnN1YnNjcmliZSgoKSA9PiB7XHJcbiAgICAgIHRoaXMuY3VycmVudFN0YXRlLmhhc05ldHdvcmtDb25uZWN0aW9uID0gZmFsc2U7XHJcbiAgICAgIHRoaXMuY2hlY2tJbnRlcm5ldFN0YXRlKCk7XHJcbiAgICAgIHRoaXMuZW1pdEV2ZW50KCk7XHJcbiAgICB9KTtcclxuICB9XHJcblxyXG4gIHByaXZhdGUgZW1pdEV2ZW50KCkge1xyXG4gICAgdGhpcy5zdGF0ZUNoYW5nZUV2ZW50RW1pdHRlci5lbWl0KHRoaXMuY3VycmVudFN0YXRlKTtcclxuICB9XHJcblxyXG4gIG5nT25EZXN0cm95KCk6IHZvaWQge1xyXG4gICAgdHJ5IHtcclxuICAgICAgdGhpcy5vZmZsaW5lU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XHJcbiAgICAgIHRoaXMub25saW5lU3Vic2NyaXB0aW9uLnVuc3Vic2NyaWJlKCk7XHJcbiAgICAgIHRoaXMuaHR0cFN1YnNjcmlwdGlvbi51bnN1YnNjcmliZSgpO1xyXG4gICAgfSBjYXRjaCAoZSkge1xyXG4gICAgfVxyXG4gIH1cclxuXHJcbiAgLyoqXHJcbiAgICogTW9uaXRvciBOZXR3b3JrICYgSW50ZXJuZXQgY29ubmVjdGlvbiBzdGF0dXMgYnkgc3Vic2NyaWJpbmcgdG8gdGhpcyBvYnNlcnZlci4gSWYgeW91IHNldCBcInJlcG9ydEN1cnJlbnRTdGF0ZVwiIHRvIFwiZmFsc2VcIiB0aGVuXHJcbiAgICogZnVuY3Rpb24gd2lsbCBub3QgcmVwb3J0IGN1cnJlbnQgc3RhdHVzIG9mIHRoZSBjb25uZWN0aW9ucyB3aGVuIGluaXRpYWxseSBzdWJzY3JpYmVkLlxyXG4gICAqIEBwYXJhbSByZXBvcnRDdXJyZW50U3RhdGUgUmVwb3J0IGN1cnJlbnQgc3RhdGUgd2hlbiBpbml0aWFsIHN1YnNjcmlwdGlvbi4gRGVmYXVsdCBpcyBcInRydWVcIlxyXG4gICAqL1xyXG4gIG1vbml0b3IocmVwb3J0Q3VycmVudFN0YXRlID0gdHJ1ZSk6IE9ic2VydmFibGU8Q29ubmVjdGlvblN0YXRlPiB7XHJcbiAgICByZXR1cm4gcmVwb3J0Q3VycmVudFN0YXRlID9cclxuICAgICAgdGhpcy5zdGF0ZUNoYW5nZUV2ZW50RW1pdHRlci5waXBlKFxyXG4gICAgICAgIGRlYm91bmNlVGltZSgzMDApLFxyXG4gICAgICAgIHN0YXJ0V2l0aCh0aGlzLmN1cnJlbnRTdGF0ZSksXHJcbiAgICAgIClcclxuICAgICAgOlxyXG4gICAgICB0aGlzLnN0YXRlQ2hhbmdlRXZlbnRFbWl0dGVyLnBpcGUoXHJcbiAgICAgICAgZGVib3VuY2VUaW1lKDMwMClcclxuICAgICAgKTtcclxuICB9XHJcblxyXG4gIC8qKlxyXG4gICAqIFVwZGF0ZSBvcHRpb25zIG9mIHRoZSBzZXJ2aWNlLiBZb3UgY291bGQgc3BlY2lmeSBwYXJ0aWFsIG9wdGlvbnMgb2JqZWN0LiBWYWx1ZXMgdGhhdCBhcmUgbm90IHNwZWNpZmllZCB3aWxsIHVzZSBkZWZhdWx0IC8gcHJldmlvdXNcclxuICAgKiBvcHRpb24gdmFsdWVzLlxyXG4gICAqIEBwYXJhbSBvcHRpb25zIFBhcnRpYWwgb3B0aW9uIHZhbHVlcy5cclxuICAgKi9cclxuICB1cGRhdGVPcHRpb25zKG9wdGlvbnM6IFBhcnRpYWw8Q29ubmVjdGlvblNlcnZpY2VPcHRpb25zPikge1xyXG4gICAgdGhpcy5zZXJ2aWNlT3B0aW9ucyA9IF8uZGVmYXVsdHMoe30sIG9wdGlvbnMsIHRoaXMuc2VydmljZU9wdGlvbnMpO1xyXG4gICAgdGhpcy5jaGVja0ludGVybmV0U3RhdGUoKTtcclxuICB9XHJcblxyXG59XHJcbiJdfQ==